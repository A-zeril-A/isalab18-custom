<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <record id="view_business_trip_tree" model="ir.ui.view">
        <field name="name">business.trip.tree.admin</field>
        <field name="model">business.trip</field>
        <field name="arch" type="xml">
          <list string="Business Trips"
                create="true"
                decoration-info="trip_status in ('draft')"
                decoration-success="trip_status == 'completed'"
                decoration-primary="trip_status in ('organization_done', 'completed_waiting_expense')"
                decoration-danger="trip_status == 'rejected'"
                decoration-muted="trip_status == 'cancelled'"
                decoration-warning="trip_status in ('submitted', 'pending_organization', 'expense_submitted', 'returned', 'expense_returned')">
            
            <!-- Essential Fields (Always Visible) -->
            <field name="id"/>
            <field name="name"/>
            <field name="display_quotation_ref" string="Linked Quotation"/>
            <field name="user_id" string="Employee"/>
            <field name="trip_status" string="Trip Status" widget="badge"/>
            <field name="submission_date" string="Submission Date"/>
            
            <!-- Travel Information -->
            <field name="destination" string="Destination" optional="show"/>
            <field name="travel_dates_display" string="Travel Dates" optional="show"/>
            <field name="trip_type" string="Trip Type" optional="show"/>
            
            <!-- Financial Information (Grouped Together) - Trip Cost Analysis -->
            <field name="manager_max_budget" string="Travel Approver Budget" optional="show" groups="custom_business_trip_management.group_business_trip_organizer,base.group_system"/>
            <field name="organizer_planned_cost" string="Planned Travel Costs"/>
            <field name="budget_difference" string="Budget Deviation" widget="monetary" options="{'currency_field': 'currency_id'}"
                   decoration-success="budget_difference &gt; 0"
                   decoration-danger="budget_difference &lt; 0"
                   decoration-info="budget_difference == 0"/>
            <field name="final_total_cost" string="Final Total Cost (Planned + Actual)" widget="monetary" options="{'currency_field': 'currency_id'}" groups="custom_business_trip_management.group_business_trip_manager,custom_business_trip_management.group_business_trip_organizer,base.group_system"/>
            <field name="budget_status" string="Budget Status" widget="badge"
                   decoration-success="budget_status == 'under_budget'"
                   decoration-danger="budget_status == 'over_budget'"
                   decoration-info="budget_status == 'on_budget'"/>
            <field name="currency_id" optional="show"/>
            
            <!-- Additional Information -->
            <field name="sale_order_id" string="Linked Quotation" optional="hide"/>
            <field name="manager_id" string="Travel Approver" optional="hide"/>
            <field name="organizer_id" string="Organizer" optional="hide"/>
            <field name="create_date" string="Created On" optional="hide"/>
            
            <!-- Technical Fields (Hidden by Default) -->
            <!-- Modified by A_zeril_A, 2025-10-24: Commented out formio-related fields after formio module removal -->
            <!--
            <field name="formio_form_builder_id" optional="hide"/>
            <field name="formio_form_submission_partner_id" optional="hide"/>
            <field name="formio_form_uuid" optional="hide"/>
            <field name="formio_form_sequence" optional="hide"/>
            <field name="formio_form_portal_share" optional="hide"/>
            <field name="formio_form_public_share" optional="hide"/>
            <field name="formio_form_public_access" optional="hide"/>
            <field name="formio_form_public_create" optional="hide"/>
            <field name="formio_form_res_model_name" string="Resource Type" optional="hide"/>
            <field name="formio_form_initial_res_model_name" string="Resource Type #1" optional="hide"/>
            <field name="formio_form_res_name" optional="hide"/>
            <field name="formio_form_res_partner_id" optional="hide"/>
            -->
            
            <button string="Open Form" groups="!custom_business_trip_management.group_business_trip_organizer,!base.group_system" name="action_view_formio" type="object" class="btn-primary"/>
            <button string="Review Form" groups="custom_business_trip_management.group_business_trip_organizer,base.group_system" name="action_view_formio" type="object" class="btn-primary"/>
          </list>
        </field>
      </record>
      
      <!-- My Business Trip Forms -->
      <record id="view_my_business_trip_tree" model="ir.ui.view">
        <field name="name">business.trip.tree.my</field>
        <field name="model">business.trip</field>
        <field name="arch" type="xml">
          <list string="My Business Trip Forms"
                js_class="my_business_trip_forms_view"
                create="false"
                decoration-warning="needs_my_action == True"
                decoration-primary="waiting_for_others == True"
                decoration-success="trip_status == 'completed'"
                decoration-muted="trip_status in ('cancelled', 'rejected')"
                decoration-info="trip_status == 'draft'">
            
            <!-- Hidden fields for smart coloring -->
            <field name="needs_my_action" invisible="1"/>
            <field name="waiting_for_others" invisible="1"/>
            
            <!-- Essential Fields (Always Visible) -->
            <field name="id"/>
            <field name="name"/>
            <field name="display_quotation_ref" string="Linked Quotation"/>
            <field name="trip_status" string="Trip Status" widget="badge"/>
            <field name="submission_date" string="Submission Date"/>
            
            <!-- Travel Information -->
            <field name="destination" string="Destination" optional="show"/>
            <field name="travel_dates_display" string="Travel Dates" optional="show"/>
            <field name="trip_type" string="Trip Type" optional="show"/>
            
            <!-- Financial Information (Grouped Together) - Only for System Administrators -->
            <field name="manager_max_budget" string="Travel Approver Budget" groups="base.group_system"/>
            <field name="organizer_planned_cost" string="Planned Travel Costs" groups="base.group_system"/>
            <field name="budget_difference" string="Budget Deviation" widget="monetary" options="{'currency_field': 'currency_id'}"
                   decoration-success="budget_difference &gt; 0"
                   decoration-danger="budget_difference &lt; 0"
                   decoration-info="budget_difference == 0"
                   groups="base.group_system"/>
            <field name="final_total_cost" string="Final Total Cost (Planned + Actual)" widget="monetary" options="{'currency_field': 'currency_id'}" groups="base.group_system"/>
            <field name="budget_status" string="Budget Status" widget="badge"
                   decoration-success="budget_status == 'under_budget'"
                   decoration-danger="budget_status == 'over_budget'"
                   decoration-info="budget_status == 'on_budget'"
                   groups="base.group_system"/>
            <field name="currency_id" optional="show" groups="base.group_system"/>
            
            <!-- Additional Information -->
            <field name="sale_order_id" string="Linked Quotation" optional="hide"/>
            <field name="manager_id" string="Travel Approver" optional="hide"/>
            <field name="organizer_id" string="Organizer" optional="hide"/>
            <field name="create_date" string="Created On" optional="hide"/>
            
            <!-- Technical Fields (Hidden by Default) -->
            <!-- Modified by A_zeril_A, 2025-10-24: Commented out formio-related field after formio module removal -->
            <!-- <field name="res_name" optional="hide"/> -->
            <button string="Open Form" groups="!custom_business_trip_management.group_business_trip_organizer,!base.group_system" class="btn-primary" name="action_view_formio" type="object"/>
            <button string="Review Form" groups="custom_business_trip_management.group_business_trip_organizer,base.group_system" class="btn-primary" name="action_view_formio" type="object"/>
          </list>
        </field>
      </record>
    
      <!-- Full Form View for Business Trip Forms -->
      <record id="view_business_trip_form" model="ir.ui.view">
        <field name="name">business.trip.form</field>
        <field name="model">business.trip</field>
        <field name="arch" type="xml">
          <form string="Form" edit="false" create="false" delete="false">
            <header> <!-- Header 1: Form Completion Status -->
                <!-- Form completion status bar - shows if form data entry is complete -->
                <field name="form_completion_status" widget="statusbar" 
                       statusbar_visible="awaiting_completion,form_completed"
                       decoration-info="form_completion_status == 'awaiting_completion'"
                       decoration-success="form_completion_status == 'form_completed'"
                       decoration-danger="form_completion_status == 'cancelled'"
                       readonly="1"/>
                
                <!-- Open Form button - visible when form is awaiting completion -->
                <button name="action_view_formio" type="object" string="Open Form"
                        invisible="form_completion_status == 'form_completed' or is_current_user_owner == False"
                        class="btn-primary"
                        help="Open form to complete data entry"/>
                        
                <!-- Review Form button for managers and organizers - visible in all states -->
                <button name="action_view_formio" type="object" string="Review Form"
                        invisible="(is_current_user_owner and form_completion_status != 'form_completed') or (not is_manager and not is_organizer and (not is_current_user_owner or form_completion_status != 'form_completed'))"
                        class="btn-info"
                        help="Review employee's business trip form submission"/>
                        
                <!-- Edit Form button - visible when form is completed -->
                <button name="action_edit_form" type="object" string="Edit Form" 
                        invisible="form_completion_status != 'form_completed' or not is_current_user_owner or trip_status not in ['draft', 'returned'] or not is_from_my_business_trip"
                        class="btn-warning"
                        help="Edit the completed form"/>
                        
                <!-- Cancel button renamed to Cancel Request -->
                <button name="action_cancel_trip" type="object" string="Cancel Request"
                        invisible="not can_cancel_trip or not is_current_user_owner or trip_status != 'draft'"
                        class="btn-danger"
                        confirm="Are you sure you want to cancel this trip request? This action cannot be undone."
                        help="Cancel this business trip request permanently."/>
            </header>
            <header invisible="(form_completion_status != 'form_completed' and trip_status != 'returned') or trip_status in ['cancelled', 'rejected']"> <!-- Header 2: Trip Request & Organization Phase -->
                <field name="trip_status_phase1" widget="statusbar" 
                       statusbar_visible="draft,submitted,pending_organization,organization_done"
                       decoration-info="trip_status_phase1 == 'draft'" 
                       decoration-warning="trip_status_phase1 in ('submitted', 'pending_organization')" 
                       decoration-orange="trip_status_phase1 == 'returned'"
                       decoration-danger="trip_status_phase1 == 'rejected'"
                       decoration-success="trip_status_phase1 == 'organization_done'"
                       decoration-muted="trip_status_phase1 == 'cancelled'"
                      />

                <!-- Badge indicator for Returned to Employee status -->
                <div class="alert alert-warning d-flex align-items-center" role="alert" style="margin: 2px 0 8px 0; padding: 8px 15px; border-left: 5px solid #ffc107;" 
                     invisible="trip_status != 'returned'">
                    <i class="fa fa-exclamation-triangle mr-2" style="font-size: 18px;" title="Warning"></i>
                    <div>
                        <strong>Action Required:</strong> Your trip request has been returned for revision. Please check the comments and resubmit.
                    </div>
                </div>

                <!-- Badge indicator for Cancelled status -->
                <div class="alert alert-secondary d-flex align-items-center" role="alert" style="margin: 2px 0 8px 0; padding: 8px 15px; border-left: 5px solid #6c757d;" 
                     invisible="trip_status != 'cancelled'">
                    <i class="fa fa-ban mr-2" style="font-size: 18px; color: #6c757d;" title="Cancelled"></i>
                    <div style="color: #6c757d;">
                        <strong>Trip Cancelled:</strong> This business trip request has been cancelled and cannot be processed further.
                    </div>
                </div>

                <!-- Add a new alert for rejected status -->
                <div class="alert alert-danger d-flex align-items-center" role="alert" style="margin: 2px 0 8px 0; padding: 8px 15px; border-left: 5px solid #dc3545;" 
                     invisible="trip_status != 'rejected'">
                    <i class="fa fa-times-circle mr-2" style="font-size: 18px; color: #dc3545;" title="Rejected"></i>
                    <div>
                        <strong>Trip Rejected:</strong> This business trip request has been rejected. Check the rejection reason for details.
                    </div>
                </div>

                <!-- Employee: Draft or Returned (from manager before organizer assignment or after rejection for rework) -->
                <!-- Submit button - available when details are complete and in draft status -->
                <button name="action_submit_to_manager" type="object" string="Submit for Approval"
                    class="oe_highlight"
                    invisible="trip_status != 'draft' or not is_current_user_owner or not has_trip_details or not is_from_my_business_trip"
                    help="Submit this business trip request for manager approval."/>
                    
                <!-- Resubmit button - available when details are complete and in returned status -->
                <button name="action_submit_to_manager" type="object" string="Resubmit to Travel Approver"
                    class="oe_highlight"
                    invisible="trip_status != 'returned' or not is_current_user_owner or not has_trip_details or not is_from_my_business_trip or form_completion_status != 'form_completed'"
                    help="Resubmit this business trip request after making requested changes."/>
                
                <!-- Disabled Resubmit button - shown when form is incomplete in returned status -->
                <button name="action_show_missing_details_warning" string="Resubmit (Complete Form First)" 
                    type="object" 
                    invisible="trip_status != 'returned' or not is_current_user_owner or form_completion_status == 'form_completed' or not is_from_my_business_trip"
                    class="btn-secondary"
                    help="You must complete the form before resubmitting. Use the 'Edit Form' or 'Open Form' button."/>
                
                <!-- Disabled Submit button - shown when details are incomplete -->
                <button name="action_show_missing_details_warning" string="Submit (Fill Details First)" 
                    type="object" 
                    invisible="trip_status != 'draft' or not is_current_user_owner or has_trip_details or not is_from_my_business_trip"
                    class="btn-secondary"
                    help="You must complete all trip details before submitting. Use the 'Edit Trip Details' button."/>
                    
                <!-- Add Edit Trip Details button next to Submit button -->
                <!-- This button will be removed -->
                <!-- <button name="action_edit_trip_details" string="Edit Trip Details" type="object"
                    class="btn-info"
                    invisible="trip_status not in ['draft', 'submitted', 'returned'] or not is_current_user_owner"
                    help="Edit business trip details"/> -->

                <!-- Travel Approver/Admin: When 'submitted' -->
                <button name="action_manager_assign_organizer_and_budget" type="object" string="Assign Org. &amp; Budget"
                        class="oe_highlight"
                        invisible="trip_status != 'submitted' or not is_manager or not is_from_assigned_to_me"
                        groups="custom_business_trip_management.group_business_trip_manager,base.group_system"
                        help="Open wizard to assign an organizer and set the maximum budget for this trip."/>
                <button name="action_open_return_comment_wizard" type="object" string="Return to Emp."
                    class="btn-warning"
                        invisible="trip_status != 'submitted' or not is_manager or not is_from_assigned_to_me"
                        groups="custom_business_trip_management.group_business_trip_manager,base.group_system"
                        help="Return the business trip request to employee with comments for revision."/>
                <button name="action_open_rejection_wizard" string="Reject" type="object" class="btn-danger"
                        invisible="trip_status != 'submitted' or not is_manager or not is_from_assigned_to_me"
                        groups="custom_business_trip_management.group_business_trip_manager,base.group_system"
                        help="Reject this business trip request."/>

                <!-- Organizer: When 'pending_organization' -->
                <button name="action_organizer_confirm_planning" type="object" string="Confirm Plan &amp; Notify Emp."
                    class="oe_highlight"
                        invisible="trip_status != 'pending_organization' or not is_organizer or not is_from_assigned_to_me"
                        groups="custom_business_trip_management.group_business_trip_organizer,base.group_system"
                        help="Confirm that trip organization is complete. This will notify the employee."/>
                
                <!-- Button for opening organizer planning wizard -->
                <button name="action_open_organizer_plan_wizard" string="Edit Trip Plan" type="object"
                    class="btn-info"
                    invisible="trip_status != 'pending_organization' or not is_organizer or not is_from_assigned_to_me"
                    groups="custom_business_trip_management.group_business_trip_organizer"
                    help="Edit trip plan details, cost, and attachments"/>
            </header>
            <header invisible="trip_status not in ['organization_done', 'completed_waiting_expense', 'expense_submitted', 'expense_returned', 'completed']"> <!-- Header 3: Trip Execution & Expense Management Phase -->
                <field name="is_expense_returned" invisible="1"/>
                
                <!-- EXPENSE MANAGEMENT: Show expense states -->
                <field name="trip_status_phase2" widget="statusbar"
                       invisible="trip_status not in ['organization_done', 'completed_waiting_expense', 'expense_submitted', 'expense_returned', 'completed']"
                       statusbar_visible="completed_waiting_expense,expense_submitted,completed"
                       decoration-warning="trip_status_phase2 == 'expense_submitted'"
                       decoration-info="trip_status_phase2 == 'completed_waiting_expense'"
                       decoration-success="trip_status_phase2 == 'completed'"
                       decoration-orange="trip_status_phase2 == 'expense_returned'"/>
                
                <!-- Badge indicator for Expense Returned status -->
                <div class="alert alert-warning d-flex align-items-center" role="alert" style="margin: 2px 0 8px 0; padding: 8px 15px; border-left: 5px solid #ffc107;" 
                     invisible="not is_expense_returned">
                    <i class="fa fa-exclamation-triangle mr-2" style="font-size: 18px;" title="Warning"></i>
                    <div>
                        <strong>Action Required:</strong> The expenses have been returned for revision. Please check the comments and resubmit.
                    </div>
                </div>
                


                <!-- Employee: When 'completed_waiting_expense' -->
                <button name="action_open_expense_submission_wizard" type="object" string="Submit Expenses"
                      class="btn-primary oe_highlight"
                      invisible="trip_status != 'completed_waiting_expense' or not is_current_user_owner or not is_from_my_business_trip"
                      help="Submit your expenses for this trip."/>

                <!-- Employee: When 'expense_returned' -->
                <button name="action_open_expense_submission_wizard" type="object" string="Resubmit Expenses"
                      class="btn-primary oe_highlight"
                      invisible="trip_status != 'expense_returned' or not is_current_user_owner or not is_from_my_business_trip"
                      help="Resubmit your expenses after making the requested changes."/>

                <!-- Actions for 'expense_submitted' -->
                <button name="action_user_undo_expense_submission" type="object" string="Recall Expenses"
                      class="btn-warning"
                      invisible="trip_status != 'expense_submitted' or not is_current_user_owner or not is_from_my_business_trip"
                      confirm="Are you sure you want to recall your expense submission for editing? This is only possible if it has not been processed yet."
                      help="Recall your submitted expenses for further editing before they are processed."/>
                <button name="action_open_expense_return_comment_wizard" type="object" string="Return Expenses"
                      class="btn-warning"
                      invisible="trip_status != 'expense_submitted' or not is_from_assigned_to_me or (not is_finance and not is_organizer)"
                      help="Return expense submission to employee with comments for revision."/>

                <!-- New button for expense approval -->
                <button name="action_approve_expenses" type="object" string="Approve Expenses"
                      class="btn-success oe_highlight"
                      invisible="trip_status != 'expense_submitted' or not is_from_assigned_to_me or (not is_finance and not is_organizer)"
                      help="Approve the submitted expenses and complete the business trip process."/>

                <!-- Travel Approver/Admin/Finance: When 'completed' (after expense approval) -->
                <button name="action_manager_undo_expense_approval" type="object" string="Undo Exp. Approval"
                    class="btn-danger"
                    invisible="trip_status != 'completed' or not can_undo_expense_approval_action or not is_from_assigned_to_me"
                        groups="custom_business_trip_management.group_business_trip_manager,base.group_system"
                    confirm="Are you sure you want to undo the expense approval? This will move the request back to 'Expenses Under Review' for review."
                    help="Undo the approval of expenses. The request will return to 'Expenses Under Review' state."/>
            </header>

            <sheet>
              <div class="oe_button_box" name="button_box">
                <!-- Smart Button for linked Sale Order -->
                <button name="action_view_sale_order" 
                        type="object" 
                        class="oe_stat_button" 
                        icon="fa-usd" 
                        invisible="not sale_order_id"
                        help="View the linked sales order/quotation">
                    <field name="sale_order_id" invisible="1"/>
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Sales Order</span>
                    </div>
                </button>
                
                <button name="action_view_formio" type="object" class="oe_stat_button" icon="fa-file-text-o" string="View Original Request"/>
              </div>
              <div class="oe_title">
                <label for="name"/>
                <h1>
                  <field name="name" readonly="1"/>
                </h1>
              </div>

              <!-- Hidden fields -->
              <!-- Modified by A_zeril_A, 2025-10-24: Commented out formio-related fields after formio module removal -->
              <!-- <field name="allow_force_update_state" invisible="1"/> -->
              <!-- <field name="allow_copy" invisible="1"/> -->
              <!-- <field name="copy_to_current" invisible="1"/> -->
              <!-- <field name="form_completion_status" invisible="1"/> REMOVED - Already defined in statusbar -->
              <field name="is_manager" invisible="1"/>
              <field name="is_finance" invisible="1"/>
              <field name="is_organizer" invisible="1"/>
              <field name="can_cancel_trip" invisible="1"/>
              <field name="is_current_user_owner" invisible="1"/>
              <field name="can_undo_expense_approval_action" invisible="1"/>
              <field name="is_from_assigned_to_me" invisible="1"/>
              <field name="is_from_my_business_trip" invisible="1"/>
              <field name="trip_status" invisible="1"/>
              <field name="has_trip_details" invisible="1"/>
              <field name="edit_in_returned_state" invisible="1"/>
              <field name="accommodation_needed" invisible="1"/>
              <field name="has_any_transportation" invisible="1"/>
              <field name="has_any_return_transportation" invisible="1"/>
              <field name="use_airplane" invisible="1"/>
              <field name="use_return_airplane" invisible="1"/>
              <field name="use_rental_car" invisible="1"/>
              <field name="use_return_rental_car" invisible="1"/>
              <field name="use_train" invisible="1"/>
              <field name="use_return_train" invisible="1"/>
              <field name="use_bus" invisible="1"/>
              <field name="use_return_bus" invisible="1"/>

              <group>
                <group string="Trip Information">
                    <field name="destination" readonly="1"/>
                    <field name="purpose" readonly="1" widget="text"/>
                    <field name="travel_start_date" string="Requested Start Date" readonly="1"/>
                    <field name="travel_end_date" string="Requested End Date" readonly="1"/>
                    <field name="travel_duration_days" string="Requested Duration (Days)" readonly="1"/>


                    
                    <!-- Hide original technical fields -->
                    <field name="actual_start_date" invisible="1"/>
                    <field name="actual_end_date" invisible="1"/>

                    <field name="trip_type" invisible="1"/>
                </group>
                <group string="Approval Information">
                  <field name="user_id" string="Employee" readonly="1"/>

                  <field name="manager_id" readonly="1"/>
                  <field name="organizer_id" readonly="1"/>
                  <field name="submission_date" readonly="1"/>
                  <field name="manager_approval_date" string="Travel Approver Initial Approval Date" invisible="not manager_approval_date" readonly="1"/>
                  <field name="organizer_confirmation_date" readonly="1" string="Organizer Plan Approval Date"/>
                  <field name="rejection_reason" invisible="trip_status != 'rejected'"/>
                  <field name="rejection_comment" invisible="trip_status != 'rejected'"/>
                  <field name="rejected_by" readonly="1" invisible="trip_status != 'rejected'"/>
                  <field name="rejection_date" readonly="1" invisible="trip_status != 'rejected'"/>
                </group>
              </group>
              <!-- Invisible fields needed for conditional attributes -->
              <field name="trip_status" invisible="1"/>
              <field name="is_manager" invisible="1"/>
              <field name="is_organizer" invisible="1"/>
              <field name="is_finance" invisible="1"/>
              <field name="can_see_costs" invisible="1"/>
              <field name="is_current_user_owner" invisible="1"/>
              <field name="can_cancel_trip" invisible="1"/>
              <field name="has_trip_details" invisible="1"/>

            <notebook>
              <!-- The 'Trip Details' page has been removed as it contained redundant information 
                   already present in the main sheet and the 'Request Form Data' tab. -->
              
                <page string="Request Form Data" name="request_form_data">
                    <!-- Hidden fields needed for conditional logic in this tab -->
                    <!-- Modified by A_zeril_A, 2025-10-24: Commented out formio-related field after formio module removal -->
                    <!-- <field name="submission_data" invisible="1"/> -->
                    <field name="accommodation_needed" invisible="1"/> 
                    <field name="has_any_transportation" invisible="1"/>
                    <field name="has_any_return_transportation" invisible="1"/>
                    <field name="use_rental_car" invisible="1"/>
                    <field name="use_train" invisible="1"/>
                    <field name="use_airplane" invisible="1"/>
                    <field name="use_bus" invisible="1"/>
                    <field name="use_company_car" invisible="1"/>
                    <field name="use_personal_car" invisible="1"/>
                    <field name="use_return_rental_car" invisible="1"/>
                    <field name="use_return_train" invisible="1"/>
                    <field name="use_return_airplane" invisible="1"/>
                    <field name="use_return_bus" invisible="1"/>
                    <field name="use_return_company_car" invisible="1"/>
                    <field name="use_return_personal_car" invisible="1"/>
                    
                    <!-- Modified by A_zeril_A, 2025-10-24: Changed attrs from submission_data to id check -->
                    <div class="alert alert-info mb-3" role="alert" invisible="id">
                        <i class="fa fa-info-circle mr-2"></i>
                        <span>No form data is available. This data is only available after the form has been submitted.</span>
                    </div>

                    <!-- Requester Information Section -->
                    <div>
                        <h4 style="border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">
                            <i class="fa fa-user mr-2" title="Requester Information"></i>Requester Information
                        </h4>
                    </div>
                    <group invisible="not id">
                        <field name="full_name" string="Requester Name" readonly="1"/>
                    </group>
                    
                    <!-- Trip Overview Section -->
                    <div>
                        <h4 style="border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">
                            <i class="fa fa-info-circle mr-2" title="Trip Overview"></i>Trip Overview
                        </h4>
                    </div>
                    <!-- Modified by A_zeril_A, 2025-10-24: Changed attrs from submission_data to id check -->
                    <group invisible="not id">
                        <field name="destination" readonly="1"/>
                        <field name="travel_start_date" readonly="1"/>
                        <field name="travel_end_date" readonly="1"/>
                        <field name="trip_duration_type" readonly="1"/>
                        <field name="trip_type" readonly="1"/>
                    </group>

                    <!-- ====== Outbound Transportation Details from BTD ====== -->
                    <!-- Modified by A_zeril_A, 2025-10-24: Changed attrs from submission_data to id check -->
                    <div invisible="not id or not has_any_transportation">
                        <h4 style="border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">
                            <i class="fa fa-arrow-right mr-2" title="Outbound Transportation"></i>Outbound Transportation
                        </h4>
                    </div>
                    <group invisible="not id or not has_any_transportation">
                        <div class="alert alert-info" role="alert" invisible="has_any_transportation">
                            <span>No outbound transportation details found in the submitted form data.</span>
                        </div>
                        
                        <!-- Outbound Rental Car -->
                        <group string="Rental Car" invisible="not use_rental_car" class="o_inner_group">
                            <group>
                                <field name="rental_car_pickup_point" readonly="1"/>
                                <field name="rental_car_pickup_date" readonly="1"/>
                                <field name="rental_car_pickup_flexible" readonly="1"/>
                                <field name="rental_car_kilometer_limit" readonly="1" invisible="rental_car_unlimited_km"/>
                                <field name="rental_car_unlimited_km" readonly="1"/>
                            </group>
                            <group>
                                <field name="rental_car_dropoff_point" readonly="1"/>
                                <field name="rental_car_dropoff_date" readonly="1"/>
                                <field name="rental_car_dropoff_flexible" readonly="1"/>
                                <field name="rental_car_type" readonly="1"/>
                                <field name="rental_car_credit_card" readonly="1"/>
                                <field name="rental_car_drivers_license_download_link_html" readonly="1" widget="html"/>
                                <field name="rental_car_drivers_license" invisible="1"/>
                                <field name="rental_car_drivers_license_download_url" invisible="1"/>
                            </group>
                            <group colspan="2"> <!-- Adjusted colspan to 2 as it's inside a 2-col group -->
                                 <field name="rental_car_preferences" readonly="1" widget="text" placeholder="No special preferences specified."/>
                            </group>
                        </group>

                        <!-- Outbound Train -->
                        <group string="Train" invisible="not use_train" class="o_inner_group">
                            <group>
                                <field name="train_departure_city" readonly="1"/>
                                <field name="train_departure_station" readonly="1"/>
                                <field name="train_departure_date" readonly="1"/>
                                <field name="train_departure_flexible" readonly="1"/>
                            </group>
                            <group>
                                <field name="train_arrival_station" readonly="1"/>
                                <field name="train_arrival_date" readonly="1"/>
                                <field name="train_arrival_flexible" readonly="1"/>
                            </group>
                        </group>

                        <!-- Outbound Airplane -->
                        <group string="Airplane" invisible="not use_airplane" class="o_inner_group">
                            <group>
                                <field name="airplane_departure_airport" readonly="1"/>
                                <field name="airplane_departure_date" readonly="1"/>
                                <field name="airplane_departure_flexible" readonly="1"/>
                            </group>
                            <group>
                                <field name="airplane_arrival_airport" readonly="1"/>
                                <field name="airplane_arrival_flexible" readonly="1"/>
                                <field name="airplane_baggage_type" readonly="1"/>
                            </group>
                            <group colspan="2">
                                <field name="airplane_preferences" readonly="1" widget="text" placeholder="No special preferences specified."/>
                            </group>
                        </group>

                        <!-- Outbound Bus -->
                        <group string="Bus" invisible="not use_bus" class="o_inner_group">
                            <group>
                                <field name="bus_departure_city" readonly="1"/>
                                <field name="bus_departure_terminal" readonly="1"/>
                                <field name="bus_departure_date" readonly="1"/>
                                <field name="bus_departure_flexible" readonly="1"/>
                            </group>
                            <group>
                                <field name="bus_arrival_terminal" readonly="1"/>
                                <field name="bus_arrival_date" readonly="1"/>
                                <field name="bus_arrival_flexible" readonly="1"/>
                            </group>
                        </group>
                        
                        <!-- Outbound Company/Personal Car (Minimal Info) -->
                         <group string="Company Car" invisible="not use_company_car" class="o_inner_group">
                            <field name="use_company_car" string="Selected" readonly="1" widget="boolean_toggle"/>
                        </group>
                         <group string="Personal Car" invisible="not use_personal_car" class="o_inner_group">
                            <field name="use_personal_car" string="Selected" readonly="1" widget="boolean_toggle"/>
                        </group>
                    </group>

                    <!-- Spacer not needed if groups handle spacing -->
                    <!-- <div style="height: 20px;"/> -->

                    <!-- ====== Return Transportation Details from BTD ====== -->
                    <!-- Modified by A_zeril_A, 2025-10-24: Changed attrs from submission_data to id check -->
                    <div invisible="not id or not has_any_return_transportation">
                        <h4 style="border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">
                            <i class="fa fa-arrow-left mr-2" title="Return Transportation"></i>Return Transportation
                        </h4>
                    </div>
                    <group invisible="not id or not has_any_return_transportation">
                         <div class="alert alert-info" role="alert" invisible="has_any_return_transportation">
                            <span>No return transportation details found in the submitted form data.</span>
                        </div>

                        <!-- Return Rental Car -->
                        <group string="Rental Car" invisible="not use_return_rental_car" class="o_inner_group">
                            <group>
                                <field name="return_rental_car_pickup_point" readonly="1"/>
                                <field name="return_rental_car_pickup_date" readonly="1"/>
                                <field name="return_rental_car_pickup_flexible" readonly="1"/>
                                <field name="return_rental_car_kilometer_limit" readonly="1" invisible="return_rental_car_unlimited_km"/>
                                <field name="return_rental_car_unlimited_km" readonly="1"/>
                            </group>
                            <group>
                                <field name="return_rental_car_dropoff_point" readonly="1"/>
                                <field name="return_rental_car_dropoff_date" readonly="1"/>
                                <field name="return_rental_car_dropoff_flexible" readonly="1"/>
                                <field name="return_rental_car_type" readonly="1"/>
                                <field name="return_rental_car_credit_card" readonly="1"/>
                                <field name="return_rental_car_drivers_license_download_link_html" readonly="1" widget="html"/>
                                <field name="return_rental_car_drivers_license" invisible="1"/>
                                <field name="return_rental_car_drivers_license_download_url" invisible="1"/>
                            </group>
                             <group colspan="2">
                                 <field name="return_rental_car_preferences" readonly="1" widget="text" placeholder="No special preferences specified."/>
                            </group>
                        </group>

                        <!-- Return Train -->
                        <group string="Train" invisible="not use_return_train" class="o_inner_group">
                            <group>
                                <field name="return_train_departure_city" readonly="1"/>
                                <field name="return_train_departure_station" readonly="1"/>
                                <field name="return_train_departure_date" readonly="1"/>
                                <field name="return_train_departure_flexible" readonly="1"/>
                            </group>
                            <group>
                                <field name="return_train_arrival_station" readonly="1"/>
                                <field name="return_train_arrival_date" readonly="1"/>
                                <field name="return_train_arrival_flexible" readonly="1"/>
                            </group>
                        </group>

                        <!-- Return Airplane -->
                        <group string="Airplane" invisible="not use_return_airplane" class="o_inner_group">
                            <group>
                                <field name="return_airplane_departure_airport" readonly="1"/>
                                <field name="return_airplane_departure_date" readonly="1"/>
                                <field name="return_airplane_departure_flexible" readonly="1"/>
                            </group>
                            <group>
                                <field name="return_airplane_destination_airport" readonly="1"/>
                                <field name="return_airplane_destination_flexible" readonly="1"/>
                                <field name="return_airplane_baggage_type" readonly="1"/>
                            </group>
                            <group colspan="2">
                                 <field name="return_airplane_preferences" readonly="1" widget="text" placeholder="No special preferences specified."/>
                            </group>
                        </group>

                        <!-- Return Bus -->
                        <group string="Bus" invisible="not use_return_bus" class="o_inner_group">
                            <group>
                                <field name="return_bus_departure_city" readonly="1"/>
                                <field name="return_bus_departure_station" readonly="1"/>
                                <field name="return_bus_departure_date" readonly="1"/>
                                <field name="return_bus_departure_flexible" readonly="1"/>
                            </group>
                            <group>
                                <field name="return_bus_arrival_station" readonly="1"/>
                                <field name="return_bus_arrival_date" readonly="1"/>
                                <field name="return_bus_arrival_flexible" readonly="1"/>
                            </group>
                        </group>
                        
                        <!-- Return Company/Personal Car (Minimal Info) -->
                         <group string="Company Car" invisible="not use_return_company_car" class="o_inner_group">
                            <field name="use_return_company_car" string="Selected" readonly="1" widget="boolean_toggle"/>
                        </group>
                         <group string="Personal Car" invisible="not use_return_personal_car" class="o_inner_group">
                            <field name="use_return_personal_car" string="Selected" readonly="1" widget="boolean_toggle"/>
                        </group>
                    </group>
                    
                    <!-- Accompanying Persons Section -->
                    <div invisible="not accompanying_person_ids">
                        <h4 style="border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">
                            <i class="fa fa-users mr-2" title="Accompanying Persons"></i>Accompanying Persons
                        </h4>
                        <field name="accompanying_person_ids" invisible="1"/>
                        <field name="accompanying_persons_html" nolabel="1"/>
                    </div>

                    <div class="o_horizontal_separator mt32" invisible="accommodation_needed in (False, 'no')">
                        <h4 style="border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">
                            <i class="fa fa-fw fa-bed" title="Accommodation Details"/>
                            Accommodation Details
                        </h4>
                    </div>
                    <group invisible="accommodation_needed in (False, 'no')">
                        <group>
                            <field name="accommodation_needed"/>
                            <field name="accommodation_residence_city"/>
                            <field name="accommodation_check_in_date"/>
                            <field name="accommodation_check_out_date"/>
                        </group>
                        <group>
                            <field name="accommodation_points_of_interest"/>
                            <field name="accommodation_need_24h_reception"/>
                            <field name="accommodation_number_of_people"/>
                        </group>
                    </group>
                </page>

                <page string="Organizer's Plan" name="organizer_plan" invisible="trip_status not in ['organization_done', 'completed_waiting_expense', 'expense_submitted', 'expense_returned', 'completed']">
                    
                    <!-- Hidden fields needed for conditional logic -->
                    <field name="structured_plan_items_json" invisible="1"/>
                    <field name="organizer_plan_has_flight" invisible="1"/>
                    <field name="organizer_plan_has_train" invisible="1"/>
                    <field name="organizer_plan_has_hotel" invisible="1"/>
                    <field name="organizer_plan_has_car_rental" invisible="1"/>
                    <field name="organizer_plan_has_other" invisible="1"/>
                    <field name="can_see_costs" invisible="1"/>
                    
                    <!-- Alert message for empty plan -->
                    <div class="alert alert-info mb-3" role="alert" invisible="organizer_plan_has_flight or organizer_plan_has_train or organizer_plan_has_hotel or organizer_plan_has_car_rental or organizer_plan_has_other or organizer_trip_plan_details">
                        <i class="fa fa-info-circle mr-2"></i>
                        <span>The organizer has not yet provided detailed trip plan information.</span>
                    </div>

                    <!-- Organizer Information Section -->
                    <div>
                        <h4 style="border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">
                            <i class="fa fa-user-tie mr-2" title="Organizer Information"></i>Organizer Information
                        </h4>
                    </div>
                    <group>
                        <field name="organizer_id" readonly="1" string="Trip Organizer"/>
                        <field name="organizer_confirmation_date" readonly="1" string="Plan Confirmation Date"/>
                        <field name="organizer_planned_cost" readonly="1" string="Planned Cost" widget="monetary" invisible="organizer_planned_cost == 0 or not can_see_costs"/>
                        <field name="manager_max_budget" readonly="1" string="Travel Approver Budget" widget="monetary" invisible="manager_max_budget == 0 or not manager_max_budget or not can_see_costs"/>
                    </group>

                    <!-- Transportation Section -->
                    <div invisible="not organizer_plan_has_flight">
                        <h4 style="border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">
                            <i class="fa fa-plane mr-2" title="Air Transportation"></i>Air Transportation
                        </h4>
                    </div>
                    <group invisible="not organizer_plan_has_flight">
                        <field name="organizer_plan_flight_html" nolabel="1" readonly="1"/>
                    </group>

                    <div invisible="not organizer_plan_has_train">
                        <h4 style="border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">
                            <i class="fa fa-train mr-2" title="Train Transportation"></i>Train Transportation
                        </h4>
                    </div>
                    <group invisible="not organizer_plan_has_train">
                        <field name="organizer_plan_train_html" nolabel="1" readonly="1"/>
                    </group>

                    <div invisible="not organizer_plan_has_car_rental">
                        <h4 style="border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">
                            <i class="fa fa-car mr-2" title="Car Rental"></i>Car Rental
                        </h4>
                    </div>
                    <group invisible="not organizer_plan_has_car_rental">
                        <field name="organizer_plan_car_rental_html" nolabel="1" readonly="1"/>
                    </group>

                    <!-- Accommodation Section -->
                    <div invisible="not organizer_plan_has_hotel">
                        <h4 style="border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">
                            <i class="fa fa-bed mr-2" title="Accommodation"></i>Accommodation
                        </h4>
                    </div>
                    <group invisible="not organizer_plan_has_hotel">
                        <field name="organizer_plan_hotel_html" nolabel="1" readonly="1"/>
                    </group>

                    <!-- Other Items Section -->
                    <div invisible="not organizer_plan_has_other">
                        <h4 style="border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">
                            <i class="fa fa-list mr-2" title="Other Items"></i>Other Items
                        </h4>
                    </div>
                    <group invisible="not organizer_plan_has_other">
                        <field name="organizer_plan_other_html" nolabel="1" readonly="1"/>
                    </group>

                    <!-- Additional Notes Section -->
                    <div invisible="not organizer_trip_plan_details">
                        <h4 style="border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">
                            <i class="fa fa-sticky-note mr-2" title="Additional Notes"></i>Additional Notes from Organizer
                        </h4>
                    </div>
                    <group invisible="not organizer_trip_plan_details">
                        <field name="organizer_trip_plan_details" readonly="1" nolabel="1" widget="text" placeholder="No additional notes from the organizer."/>
                    </group>

                    <!-- Travel Documents Section -->
                    <div invisible="not employee_documents_ids">
                        <h4 style="border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">
                            <i class="fa fa-ticket mr-2" title="Travel Documents"></i>Travel Documents
                        </h4>
                    </div>
                    <group invisible="not employee_documents_ids">
                        <field name="employee_documents_ids" widget="many2many_binary" readonly="1" nolabel="1" string="Travel Documents"/>
                    </group>

                    <!-- Organizer Attachments Section -->
                    <div invisible="not organizer_attachments_ids">
                        <h4 style="border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">
                            <i class="fa fa-paperclip mr-2" title="Organizer Attachments"></i>Organizer Attachments
                        </h4>
                    </div>
                    <group invisible="not organizer_attachments_ids">
                        <field name="organizer_attachments_ids" widget="many2many_binary" readonly="1" nolabel="1"/>
                    </group>

                    <!-- Comments to Travel Approver Section -->
                    <div invisible="not organizer_comments_to_manager or is_current_user_owner">
                        <h4 style="border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">
                            <i class="fa fa-comments mr-2" title="Comments to Travel Approver"></i>Comments to Travel Approver
                        </h4>
                    </div>
                    <group invisible="not organizer_comments_to_manager or is_current_user_owner">
                        <field name="organizer_comments_to_manager" readonly="1" nolabel="1" widget="text" placeholder="No comments from organizer to manager."/>
                    </group>

                </page>

                <page string="Expenses"
                      invisible="trip_status in ['draft', 'submitted', 'returned', 'pending_organization']">
                    <group>
                        <group string="Employee Expense Submission">
                            <field name="expense_total"
                                   readonly="1" force_save="1"/>
                            <field name="expense_attachment_ids" widget="many2many_binary" force_save="1"/>
                            <field name="actual_expense_submission_date" readonly="1"/>
                        </group>
                        <group string="Expense Approval by Organizer">
                            <field name="expense_return_comments" readonly="1"
                                   invisible="trip_status != 'expense_returned'"/>
                            <field name="expense_approval_date" readonly="1" string="Approval Date"/>
                            <field name="expense_approved_by" readonly="1"/>
                        </group>
                    </group>
                </page>
                
                <page string="Trip Cost Analysis"
                      invisible="trip_status in ['draft', 'submitted', 'returned', 'pending_organization'] or (not is_organizer and not is_manager)">
                    <group>
                        <group>
                            <field name="manager_max_budget" readonly="1" string="Travel Approver Budget" invisible="manager_max_budget == 0"/>
                            <field name="organizer_planned_cost" readonly="1" string="Planned Travel Costs"/>
                            <field name="expense_total" readonly="1" string="Employee Expenditures"/>
                            <field name="budget_difference" readonly="1" widget="monetary" options="{'currency_field': 'currency_id'}"
                                   decoration-success="budget_difference &gt; 0"
                                   decoration-danger="budget_difference &lt; 0"
                                   decoration-info="budget_difference == 0"/>
                            <field name="budget_status" readonly="1" widget="badge"
                                   decoration-success="budget_status == 'under_budget'"
                                   decoration-danger="budget_status == 'over_budget'"
                                   decoration-info="budget_status == 'on_budget'"/>
                            <field name="final_total_cost" readonly="1" widget="monetary" options="{'currency_field': 'currency_id'}"
                                   string="Final Total Cost (Planned + Actual)"
                                   invisible="trip_status != 'completed'"
                                   help="Total cost to company: sum of planned costs (organized by company) plus actual expenses (paid by employee)"/>
                        </group>
                    </group>
                </page>

                <!-- Modified by A_zeril_A, 2025-10-24: Commented out Raw JSON Data tab as it was for formio submission data -->
                <!--
                <page string="Raw JSON Data" name="raw_json_data" groups="base.group_system">
                    <group string="Raw Form Data (JSON)" attrs="{'invisible': [('submission_data', '=', False)]}">
                        <field name="form_data_json" readonly="1" nolabel="1"/>
                    </group>
                </page>
                -->

              </notebook>

              <!-- Modified by A_zeril_A, 2025-10-24: Commented out formio-related field as it no longer exists. -->
              <!-- <field name="formio_form_builder_id" string="Form Builder" attrs="{'invisible': [('id', '!=', False)]}" options="{'no_create': True}" required="0"/> -->
            </sheet>
            <!-- Odoo 18 Chatter - renders as side panel -->
            <chatter/>
          </form>
        </field>
      </record>
    
      <!-- Search View for Business Trip Forms (Admin) -->
      <record id="view_business_trip_search" model="ir.ui.view">
        <field name="name">business.trip.search</field>
        <field name="model">business.trip</field>
        <field name="arch" type="xml">
          <search string="Business Trip Forms">
            <!-- Quick Search Fields -->
            <field name="name" string="Name" filter_domain="[('name', 'ilike', self)]"/>
            <field name="user_id" string="Employee"/>
            <field name="destination" string="Destination"/>
            <field name="sale_order_id" string="Quotation Reference"/>
            
            <!-- Status Filters -->
            <separator/>
            <filter name="filter_draft" string="Draft" domain="[('trip_status', '=', 'draft')]"/>
            <filter name="filter_submitted" string="Submitted" domain="[('trip_status', '=', 'submitted')]"/>
            <filter name="filter_pending_organization" string="Pending Organization" domain="[('trip_status', '=', 'pending_organization')]"/>
            <filter name="filter_organization_done" string="Organization Done" domain="[('trip_status', '=', 'organization_done')]"/>

            <filter name="filter_completed" string="Completed" domain="[('trip_status', '=', 'completed')]"/>
            
            <separator/>
            <filter name="filter_returned" string="Returned" domain="[('trip_status', '=', 'returned')]"/>
            <filter name="filter_rejected" string="Rejected" domain="[('trip_status', '=', 'rejected')]"/>
            <filter name="filter_cancelled" string="Cancelled" domain="[('trip_status', '=', 'cancelled')]"/>
            
            <!-- Trip Type Filters -->
            <separator/>
            <filter name="filter_domestic" string="Domestic" domain="[('trip_type', '=', 'domestic')]"/>
            <filter name="filter_international" string="International" domain="[('trip_type', '=', 'international')]"/>
            
            <!-- Financial Status Filters -->
            <separator/>
            <filter name="filter_under_budget" string="Under Budget" domain="[('budget_status', '=', 'under_budget')]"/>
            <filter name="filter_on_budget" string="On Budget" domain="[('budget_status', '=', 'on_budget')]"/>
            <filter name="filter_over_budget" string="Over Budget" domain="[('budget_status', '=', 'over_budget')]"/>
            
            <!-- Date Filters -->
            <separator/>
            <filter name="filter_this_month" string="This Month" domain="[('submission_date', '&gt;=', (context_today() - relativedelta(day=1)).strftime('%Y-%m-%d'))]"/>
            <filter name="filter_last_month" string="Last Month" domain="[('submission_date', '&gt;=', (context_today() - relativedelta(months=1, day=1)).strftime('%Y-%m-%d')), ('submission_date', '&lt;', (context_today() - relativedelta(day=1)).strftime('%Y-%m-%d'))]"/>
            <filter name="filter_this_year" string="This Year" domain="[('submission_date', '&gt;=', (context_today() - relativedelta(month=1, day=1)).strftime('%Y-%m-%d'))]"/>
            
            <!-- Travel Date Filters -->
            <separator/>
            <filter name="filter_upcoming_trips" string="Upcoming Trips" domain="[('travel_start_date', '&gt;=', context_today().strftime('%Y-%m-%d'))]"/>
            <filter name="filter_past_trips" string="Past Trips" domain="[('travel_end_date', '&lt;', context_today().strftime('%Y-%m-%d'))]"/>
            <filter name="filter_current_trips" string="Current Trips" domain="[('travel_start_date', '&lt;=', context_today().strftime('%Y-%m-%d')), ('travel_end_date', '&gt;=', context_today().strftime('%Y-%m-%d'))]"/>
            
            <!-- Advanced Filters -->
            <separator/>
            <filter name="filter_has_quotation" string="Has Quotation" domain="[('sale_order_id', '!=', False)]"/>
            
            <!-- Group By Options -->
            <group expand="0" string="Group By">
              <filter name="group_by_status" string="Status" domain="[]" context="{'group_by': 'trip_status'}"/>
              <filter name="group_by_employee" string="Employee" domain="[]" context="{'group_by': 'user_id'}"/>
              <filter name="group_by_manager" string="Travel Approver" domain="[]" context="{'group_by': 'manager_id'}"/>
              <filter name="group_by_organizer" string="Organizer" domain="[]" context="{'group_by': 'organizer_id'}"/>
              <separator/>
              <filter name="group_by_destination" string="Destination" domain="[]" context="{'group_by': 'destination'}"/>
              <filter name="group_by_trip_type" string="Trip Type" domain="[]" context="{'group_by': 'trip_type'}"/>
              <filter name="group_by_budget_status" string="Budget Status" domain="[]" context="{'group_by': 'budget_status'}"/>
              <separator/>
              <filter name="group_by_submission_date" string="Submission Date" domain="[]" context="{'group_by': 'submission_date:month'}"/>
              <filter name="group_by_travel_date" string="Travel Date" domain="[]" context="{'group_by': 'travel_start_date:month'}"/>
              <filter name="group_by_create_date" string="Create Date" domain="[]" context="{'group_by': 'create_date:month'}"/>
            </group>
          </search>
        </field>
      </record>

      <!-- Search View for My Business Trip Forms -->
      <record id="view_my_business_trip_search" model="ir.ui.view">
        <field name="name">business.trip.search.my</field>
        <field name="model">business.trip</field>
        <field name="arch" type="xml">
          <search string="My Business Trip Forms">
            <!-- Quick Search Fields -->
            <field name="name" string="Name" filter_domain="[('name', 'ilike', self)]"/>
            <field name="user_id" string="Employee"/>
            <field name="destination" string="Destination"/>
            <field name="sale_order_id" string="Quotation Reference"/>
            
            <!-- Status Filters -->
            <separator/>
            <filter name="filter_draft" string="Draft" domain="[('trip_status', '=', 'draft')]"/>
            <filter name="filter_submitted" string="Submitted" domain="[('trip_status', '=', 'submitted')]"/>
            <filter name="filter_pending_organization" string="Pending Organization" domain="[('trip_status', '=', 'pending_organization')]"/>
            <filter name="filter_organization_done" string="Organization Done" domain="[('trip_status', '=', 'organization_done')]"/>

            <filter name="filter_completed" string="Completed" domain="[('trip_status', '=', 'completed')]"/>
            
            <separator/>
            <filter name="filter_returned" string="Returned" domain="[('trip_status', '=', 'returned')]"/>
            <filter name="filter_rejected" string="Rejected" domain="[('trip_status', '=', 'rejected')]"/>
            <filter name="filter_cancelled" string="Cancelled" domain="[('trip_status', '=', 'cancelled')]"/>
            
            <!-- Trip Type Filters -->
            <separator/>
            <filter name="filter_domestic" string="Domestic" domain="[('trip_type', '=', 'domestic')]"/>
            <filter name="filter_international" string="International" domain="[('trip_type', '=', 'international')]"/>
            
            <!-- Financial Status Filters (only for managers/organizers) -->
            <separator groups="custom_business_trip_management.group_business_trip_manager,custom_business_trip_management.group_business_trip_organizer,base.group_system"/>
            <filter name="filter_under_budget" string="Under Budget" domain="[('budget_status', '=', 'under_budget')]" groups="custom_business_trip_management.group_business_trip_manager,custom_business_trip_management.group_business_trip_organizer,base.group_system"/>
            <filter name="filter_on_budget" string="On Budget" domain="[('budget_status', '=', 'on_budget')]" groups="custom_business_trip_management.group_business_trip_manager,custom_business_trip_management.group_business_trip_organizer,base.group_system"/>
            <filter name="filter_over_budget" string="Over Budget" domain="[('budget_status', '=', 'over_budget')]" groups="custom_business_trip_management.group_business_trip_manager,custom_business_trip_management.group_business_trip_organizer,base.group_system"/>
            
            <!-- Date Filters -->
            <separator/>
            <filter name="filter_this_month" string="This Month" domain="[('submission_date', '&gt;=', (context_today() - relativedelta(day=1)).strftime('%Y-%m-%d'))]"/>
            <filter name="filter_last_month" string="Last Month" domain="[('submission_date', '&gt;=', (context_today() - relativedelta(months=1, day=1)).strftime('%Y-%m-%d')), ('submission_date', '&lt;', (context_today() - relativedelta(day=1)).strftime('%Y-%m-%d'))]"/>
            <filter name="filter_this_year" string="This Year" domain="[('submission_date', '&gt;=', (context_today() - relativedelta(month=1, day=1)).strftime('%Y-%m-%d'))]"/>
            
            <!-- Travel Date Filters -->
            <separator/>
            <filter name="filter_upcoming_trips" string="Upcoming Trips" domain="[('travel_start_date', '&gt;=', context_today().strftime('%Y-%m-%d'))]"/>
            <filter name="filter_past_trips" string="Past Trips" domain="[('travel_end_date', '&lt;', context_today().strftime('%Y-%m-%d'))]"/>
            <filter name="filter_current_trips" string="Current Trips" domain="[('travel_start_date', '&lt;=', context_today().strftime('%Y-%m-%d')), ('travel_end_date', '&gt;=', context_today().strftime('%Y-%m-%d'))]"/>
            
            <!-- Advanced Filters -->
            <separator/>
            <filter name="filter_has_quotation" string="Has Quotation" domain="[('sale_order_id', '!=', False)]"/>
            
            <!-- Group By Options -->
            <group expand="0" string="Group By">
              <filter name="group_by_status" string="Status" domain="[]" context="{'group_by': 'trip_status'}"/>
              <filter name="group_by_destination" string="Destination" domain="[]" context="{'group_by': 'destination'}"/>
              <filter name="group_by_trip_type" string="Trip Type" domain="[]" context="{'group_by': 'trip_type'}"/>
              <filter name="group_by_budget_status" string="Budget Status" domain="[]" context="{'group_by': 'budget_status'}" groups="custom_business_trip_management.group_business_trip_manager,custom_business_trip_management.group_business_trip_organizer,base.group_system"/>
              <separator/>
              <filter name="group_by_submission_date" string="Submission Date" domain="[]" context="{'group_by': 'submission_date:month'}"/>
              <filter name="group_by_travel_date" string="Travel Date" domain="[]" context="{'group_by': 'travel_start_date:month'}"/>
              <filter name="group_by_create_date" string="Create Date" domain="[]" context="{'group_by': 'create_date:month'}"/>
            </group>
          </search>
        </field>
      </record>

      <!-- Search View for Assigned to Me -->
      <record id="view_assigned_business_trip_search" model="ir.ui.view">
        <field name="name">business.trip.search.assigned</field>
        <field name="model">business.trip</field>
        <field name="arch" type="xml">
          <search string="Assigned Business Trips">
            <!-- Quick Search Fields -->
            <field name="name" string="Name" filter_domain="[('name', 'ilike', self)]"/>
            <field name="user_id" string="Employee"/>
            <field name="destination" string="Destination"/>
            <field name="sale_order_id" string="Quotation Reference"/>
            
            <!-- Role-based Filters -->
            <separator/>
            <filter name="filter_my_requests" string="My Requests" domain="[('user_id', '=', uid)]"/>
            <filter name="filter_as_manager" string="As Travel Approver" domain="[('manager_id', '=', uid)]"/>
            <filter name="filter_as_organizer" string="As Organizer" domain="[('organizer_id', '=', uid)]"/>
            
            <!-- Status Filters -->
            <separator/>
            <filter name="filter_needs_manager_action" string="Needs Travel Approver Action" domain="[('trip_status', 'in', ['submitted', 'pending_organization']), ('manager_id', '=', uid)]"/>
            <filter name="filter_needs_organizer_action" string="Needs Organizer Action" domain="[('trip_status', 'in', ['pending_organization', 'organization_done']), ('organizer_id', '=', uid)]"/>
            <filter name="filter_needs_employee_action" string="Needs Employee Action" domain="[('trip_status', 'in', ['draft', 'organization_done', 'completed']), ('user_id', '=', uid)]"/>
            
            <separator/>
            <filter name="filter_draft" string="Draft" domain="[('trip_status', '=', 'draft')]"/>
            <filter name="filter_submitted" string="Submitted" domain="[('trip_status', '=', 'submitted')]"/>
            <filter name="filter_pending_organization" string="Pending Organization" domain="[('trip_status', '=', 'pending_organization')]"/>
            <filter name="filter_organization_done" string="Organization Done" domain="[('trip_status', '=', 'organization_done')]"/>

            <filter name="filter_completed" string="Completed" domain="[('trip_status', '=', 'completed')]"/>
            
            <separator/>
            <filter name="filter_returned" string="Returned" domain="[('trip_status', '=', 'returned')]"/>
            <filter name="filter_rejected" string="Rejected" domain="[('trip_status', '=', 'rejected')]"/>
            <filter name="filter_cancelled" string="Cancelled" domain="[('trip_status', '=', 'cancelled')]"/>
            
            <!-- Trip Type Filters -->
            <separator/>
            <filter name="filter_domestic" string="Domestic" domain="[('trip_type', '=', 'domestic')]"/>
            <filter name="filter_international" string="International" domain="[('trip_type', '=', 'international')]"/>
            
            <!-- Financial Status Filters -->
            <separator/>
            <filter name="filter_under_budget" string="Under Budget" domain="[('budget_status', '=', 'under_budget')]"/>
            <filter name="filter_on_budget" string="On Budget" domain="[('budget_status', '=', 'on_budget')]"/>
            <filter name="filter_over_budget" string="Over Budget" domain="[('budget_status', '=', 'over_budget')]"/>
            
            <!-- Date Filters -->
            <separator/>
            <filter name="filter_this_month" string="This Month" domain="[('submission_date', '&gt;=', (context_today() - relativedelta(day=1)).strftime('%Y-%m-%d'))]"/>
            <filter name="filter_last_month" string="Last Month" domain="[('submission_date', '&gt;=', (context_today() - relativedelta(months=1, day=1)).strftime('%Y-%m-%d')), ('submission_date', '&lt;', (context_today() - relativedelta(day=1)).strftime('%Y-%m-%d'))]"/>
            <filter name="filter_this_year" string="This Year" domain="[('submission_date', '&gt;=', (context_today() - relativedelta(month=1, day=1)).strftime('%Y-%m-%d'))]"/>
            
            <!-- Travel Date Filters -->
            <separator/>
            <filter name="filter_upcoming_trips" string="Upcoming Trips" domain="[('travel_start_date', '&gt;=', context_today().strftime('%Y-%m-%d'))]"/>
            <filter name="filter_past_trips" string="Past Trips" domain="[('travel_end_date', '&lt;', context_today().strftime('%Y-%m-%d'))]"/>
            <filter name="filter_current_trips" string="Current Trips" domain="[('travel_start_date', '&lt;=', context_today().strftime('%Y-%m-%d')), ('travel_end_date', '&gt;=', context_today().strftime('%Y-%m-%d'))]"/>
            
            <!-- Advanced Filters -->
            <separator/>
            <filter name="filter_has_quotation" string="Has Quotation" domain="[('sale_order_id', '!=', False)]"/>
            
            <!-- Group By Options -->
            <group expand="0" string="Group By">
              <filter name="group_by_status" string="Status" domain="[]" context="{'group_by': 'trip_status'}"/>
              <filter name="group_by_employee" string="Employee" domain="[]" context="{'group_by': 'user_id'}"/>
              <filter name="group_by_manager" string="Travel Approver" domain="[]" context="{'group_by': 'manager_id'}"/>
              <filter name="group_by_organizer" string="Organizer" domain="[]" context="{'group_by': 'organizer_id'}"/>
              <separator/>
              <filter name="group_by_destination" string="Destination" domain="[]" context="{'group_by': 'destination'}"/>
              <filter name="group_by_trip_type" string="Trip Type" domain="[]" context="{'group_by': 'trip_type'}"/>
              <filter name="group_by_budget_status" string="Budget Status" domain="[]" context="{'group_by': 'budget_status'}"/>
              <separator/>
              <filter name="group_by_submission_date" string="Submission Date" domain="[]" context="{'group_by': 'submission_date:month'}"/>
              <filter name="group_by_travel_date" string="Travel Date" domain="[]" context="{'group_by': 'travel_start_date:month'}"/>
              <filter name="group_by_create_date" string="Create Date" domain="[]" context="{'group_by': 'create_date:month'}"/>
            </group>
          </search>
        </field>
      </record>
    
      <!-- Action for Business Trip Forms -->
      <record id="action_view_business_trip_forms" model="ir.actions.act_window">
        <field name="name">Business Trip Forms</field>
        <field name="res_model">business.trip</field>
        <field name="view_mode">list,form</field>
        <field name="view_ids" eval="[(5, 0, 0),
          (0, 0, {'view_mode': 'list', 'view_id': ref('custom_business_trip_management.view_business_trip_tree')}),
          (0, 0, {'view_mode': 'form', 'view_id': ref('custom_business_trip_management.view_business_trip_form')})]"/>
        <field name="search_view_id" ref="view_business_trip_search"/>
      </record>
      
      <!-- Action for My Business Trip Forms -->
      <record id="action_view_my_business_trip_forms" model="ir.actions.act_window">
        <field name="name">My Business Trip Forms</field>
        <field name="res_model">business.trip</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('user_id', '=', uid)]</field>
        <field name="context">{'from_my_business_trip': True}</field>
        <field name="view_ids" eval="[(5, 0, 0),
          (0, 0, {'view_mode': 'list', 'view_id': ref('custom_business_trip_management.view_my_business_trip_tree')}),
          (0, 0, {'view_mode': 'form', 'view_id': ref('custom_business_trip_management.view_business_trip_form')})]"/>
        <field name="search_view_id" ref="view_my_business_trip_search"/>
        <field name="help" type="html">
          <p class="o_view_nocontent_smiling_face">
            You haven't submitted any trip requests yet
          </p>
          <p>
            This view shows only the business trips where you are the requester (Employee role). 
            Create a new business trip form by clicking on the "Create New Request" button.
          </p>
        </field>
      </record>



    <!-- Organizer Assigned Business Trip Forms -->
    <record id="view_organizer_business_trip_tree" model="ir.ui.view">
      <field name="name">business.trip.tree.organizer</field>
      <field name="model">business.trip</field>
      <field name="arch" type="xml">
        <list string="Trips to Organize"
              decoration-info="trip_status in ('draft')"
              decoration-success="trip_status == 'completed'"
              decoration-primary="trip_status in ('organization_done', 'completed_waiting_expense')"
              decoration-danger="trip_status == 'rejected'"
              decoration-muted="trip_status == 'cancelled'"
              decoration-warning="trip_status in ('submitted', 'pending_organization', 'expense_submitted', 'returned', 'expense_returned')">
          
          <field name="id"/>
          <field name="name"/>
          <field name="user_id" string="Employee"/>
          <field name="destination"/>
          <field name="trip_type"/>
          <field name="travel_start_date"/>
          <field name="travel_end_date"/>
          <field name="manager_max_budget" string="Budget"/>
          <field name="organizer_planned_cost" string="Planned Cost"/>
          <field name="currency_id"/>
          <field name="trip_status" widget="badge"/>
          
          <button name="action_open_organizer_plan_wizard" 
                  string="Plan Trip" 
                  type="object" 
                  icon="fa-calendar" 
                  invisible="trip_status != 'pending_organization'"/>
                  
          <button name="action_organizer_confirm_planning" 
                  string="Confirm" 
                  type="object" 
                  icon="fa-check" 
                  invisible="trip_status != 'pending_organization'"/>
        </list>
      </field>
    </record>


      
    <!-- Add missing view for all assigned business trips -->
    <record id="view_all_assigned_business_trip_tree" model="ir.ui.view">
      <field name="name">business.trip.tree.all.assigned</field>
      <field name="model">business.trip</field>
      <field name="arch" type="xml">
        <list string="My Assigned Business Trips"
              create="false"
              decoration-warning="needs_my_action == True"
              decoration-primary="waiting_for_others == True"
              decoration-success="trip_status == 'completed'"
              decoration-muted="trip_status in ('cancelled', 'rejected')">
            
            <!-- Hidden fields for smart coloring -->
            <field name="needs_my_action" invisible="1"/>
            <field name="waiting_for_others" invisible="1"/>
            
            <!-- Essential Fields (Always Visible) -->
            <field name="id"/>
            <field name="name"/>
            <field name="display_quotation_ref" string="Linked Quotation"/>
            <field name="user_id" string="Employee"/>
            <field name="trip_status" string="Status" widget="badge"/>
            <field name="my_role" string="My Role"/>
            <field name="submission_date" string="Submission Date"/>
            
            <!-- Travel Information -->
            <field name="destination" optional="show"/>
            <field name="travel_start_date"/>
            <field name="travel_end_date"/>
            <field name="trip_type" optional="show"/>
            
            <!-- Financial Information (Grouped Together) - Trip Cost Analysis -->
            <field name="manager_max_budget" string="Travel Approver Budget" groups="custom_business_trip_management.group_business_trip_manager,custom_business_trip_management.group_business_trip_organizer,base.group_system"/>
            <field name="organizer_planned_cost" string="Planned Travel Costs" groups="custom_business_trip_management.group_business_trip_manager,custom_business_trip_management.group_business_trip_organizer,base.group_system"/>
            <field name="budget_difference" string="Budget Deviation" widget="monetary" options="{'currency_field': 'currency_id'}"
                   decoration-success="budget_difference &gt; 0"
                   decoration-danger="budget_difference &lt; 0"
                   decoration-info="budget_difference == 0"
                   groups="custom_business_trip_management.group_business_trip_manager,custom_business_trip_management.group_business_trip_organizer,base.group_system"/>
            <field name="final_total_cost" string="Final Total Cost (Planned + Actual)" widget="monetary" options="{'currency_field': 'currency_id'}" groups="custom_business_trip_management.group_business_trip_manager,custom_business_trip_management.group_business_trip_organizer,base.group_system"/>
            <field name="budget_status" string="Budget Status" widget="badge"
                   decoration-success="budget_status == 'under_budget'"
                   decoration-danger="budget_status == 'over_budget'"
                   decoration-info="budget_status == 'on_budget'"
                   groups="custom_business_trip_management.group_business_trip_manager,custom_business_trip_management.group_business_trip_organizer,base.group_system"/>
            <field name="currency_id" optional="show" groups="custom_business_trip_management.group_business_trip_manager,custom_business_trip_management.group_business_trip_organizer,base.group_system"/>
            
            <!-- Additional Information -->
            <field name="sale_order_id" string="Linked Quotation" optional="hide"/>
            <field name="manager_id" string="Travel Approver" optional="hide"/>
            <field name="organizer_id" string="Organizer" optional="hide"/>
            <field name="create_date" string="Created On" optional="hide"/>
            
            <!-- Technical Fields (Hidden by Default) -->
            <!-- Modified by A_zeril_A, 2025-10-24: Commented out formio-related field after formio module removal -->
            <!-- <field name="res_name" optional="hide"/> -->
            <button string="View" name="action_view_formio" type="object" class="btn-primary"/>
          </list>
      </field>
    </record>
</odoo> 