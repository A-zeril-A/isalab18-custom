<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- 
        Odoo 18 Compatible Kanban View Inheritance
        
        Hides expected_revenue and recurring_revenue fields from kanban cards
        for users without 'CRM Full Access' permission.
        
        Odoo 18 Notes:
        - Kanban uses t-name="card" template structure
        - Fields are declared outside templates (before <templates> tag)
        - Use div wrapping with t-if for conditional display
    -->
    <record id="crm_lead_kanban_inherit" model="ir.ui.view">
        <field name="name">crm.lead.kanban.view.inherit</field>
        <field name="model">crm.lead</field>
        <field name="inherit_id" ref="crm.crm_case_kanban_view_leads"/>
        <field name="priority">99</field>
        <field name="arch" type="xml">
            <!-- Add the can_see_financials field to kanban to make it available in template -->
            <xpath expr="//kanban/field[@name='stage_id']" position="after">
                <field name="can_see_financials"/>
            </xpath>

            <!-- 
                Replace the revenue div content to conditionally show based on permissions.
                The original structure is:
                <div>
                    <t t-if="record.expected_revenue.raw_value">...</t>
                    <t t-if="record.recurring_revenue...">...</t>
                </div>
            -->
            <xpath expr="//t[@t-name='card']/div[descendant::field[@name='expected_revenue']]" position="replace">
                <div t-if="record.can_see_financials.raw_value">
                    <t t-if="record.expected_revenue.raw_value">
                        <field name="expected_revenue" widget="monetary" options="{'currency_field': 'company_currency'}"/>
                        <span t-if="record.recurring_revenue and record.recurring_revenue.raw_value" groups="crm.group_use_recurring_revenues"> + </span>
                    </t>
                    <t t-if="record.recurring_revenue and record.recurring_revenue.raw_value">
                        <field class="me-1" name="recurring_revenue" widget="monetary" options="{'currency_field': 'company_currency'}" groups="crm.group_use_recurring_revenues"/>
                        <field name="recurring_plan" groups="crm.group_use_recurring_revenues"/>
                    </t>
                </div>
            </xpath>
        </field>
    </record>
</odoo>
